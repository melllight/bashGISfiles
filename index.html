<!DOCTYPE html>
<html>
	<head>
		<title>BashGIS</title>
		<link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css">
		<link rel="stylesheet" type="text/css" href="style.css">
		<script src="https://openlayers.org/en/v4.4.2/build/ol.js"></script>
    <script type="text/javascript" src="places.js"></script>

     <style>
      .rotate-north {
        top: 65px;
        left: .5em;
      }
      .ol-touch .rotate-north {
        top: 80px;
      }
    </style>

	</head>
	<body>
		<div class="header">

      <ul>

      <li class="buttons"><h2>BashGIS</h2></li>

      <li class="buttons">
        <p class="hint">Увеличение масштаба</p>
        <button id="zoom_plus">+</button>
      </li>

      <li class="buttons">
        <p class="hint">Уменьшение масштаба</p>
        <button id="zoom_minus">-</button>
      </li>

      <li class="buttons">
        <p class="hint">Поиск</p>
       <input type="text" name="search" id="search" size="12">
        <button id="find_place">Центрировать</button>
      </li>

      <li class="buttons">
        <p class="hint">Выбор слоя</p>
        <select id="layer-select">
       <option value="Aerial">Aerial</option>
       <option value="AerialWithLabels" selected>Aerial with labels</option>
       <option value="Road">Road (static)</option>
       <option value="RoadOnDemand">Road (dynamic)</option>
       <option value="Paper">Paper Style</option>
       </select></li>

      </ul>

    </div>
		<div id="map" class="map"></div>

    <div class="footer">
      <p class="hint footerHint">
        Слой карты <input type="checkbox" id="mapLayers" class="chooseLayers" checked="true">
        Векторный слой РБ <input type="checkbox" id="RBLayers" class="chooseLayers" checked="true">
        Векторный слой городов <input type="checkbox" id="CitiesLayers" class="chooseLayers" checked="true">
      </p>
    </div>

		<script type="text/javascript">
      var mapLayerOn = true;

      //Инициализация массива для нескольких слоев
       var styles = [
        'Road',
        'RoadOnDemand',
        'Aerial',
        'AerialWithLabels',
      ];
      var layers = [];
      var i, ii;
      for (i = 0, ii = styles.length; i < ii; ++i) {
        layers.push(new ol.layer.Tile({
          visible: false,
          preload: Infinity,
          source: new ol.source.BingMaps({
            key: 'AkPePzQAUoC7qKlVTNT4nw0Ykq2EJ4nLE9Iq8-7NZY4wI2Owxebqqur_4zMiboZh',
            imagerySet: styles[i]
          })
        }));
      }

      styles.push('Paper');

      layers.push
      (new ol.layer.Tile({
        visible: false,
        preload: Infinity,
        source: new ol.source.TileJSON
        ({
          url: 'https://api.tiles.mapbox.com/v3/mapbox.geography-class.json?secure',
          crossOrigin: ''
        })
      }));

      layers.push (
        new ol.layer.Vector({
          source: new ol.source.Vector({
            url: 'https://raw.githubusercontent.com/VaJau2/bashGISfiles/master/Города.geojson',
            format: new ol.format.GeoJSON()
          })
        })
        );

      layers.push (
        new ol.layer.Vector({
          source: new ol.source.Vector({
            url: 'https://raw.githubusercontent.com/VaJau2/bashGISfiles/master/Шейп.geojson',
            format: new ol.format.GeoJSON()
          })
        })
        );
      
       window.app = {}; //Скопированный с OL код 
      var app = window.app;

			var map = new ol.Map({
         controls: ol.control.defaults({
           attributionOptions: ({
             collapsible: false
           })
          }),

          layers: layers,

           loadTilesWhileInteracting: true,

     		   target: 'map',   

      		 view: new ol.View({
              extent: [6000000, 7000000, 6700000, 7500000],
      			  center: [6000000,7000000],
              minZoom: 5,
              maxZoom: 16,
       			  zoom: 5,
     	    	}),
    	    });
      var view = map.getView();

      var destLoc = [-50,-50];
      var currentLoc = [50,50];
      var ext = ol.extent.boundingExtent([destLoc,currentLoc]);
      ext = ol.proj.transformExtent(ext, ol.proj.get('EPSG:4326'), ol.proj.get('EPSG:3857'));

      view.fit(ext,map.getSize());

       function flyTo(location, done) {
        var duration = 2000;
        var parts = 2;
        var called = false;
        function callback(complete) {
          --parts;
          if (called) {
            return;
          }
          if (parts === 0 || !complete) {
            called = true;
            done(complete);
          }
        }

        view.animate({
          center: location,
          duration: duration
        }, callback);
        view.animate({ 
          zoom: 15,
          duration: duration
        }, callback);
      }

      //Доп код для выборки слоев - тут код для самой кнопки
      var select = document.getElementById('layer-select');

      function onChange() {
        var style = select.value;
        for (let i = 0, ii = styles.length; i < ii; ++i) {
          layers[i].setVisible((styles[i] === style) && mapLayerOn);
        }
      }

      select.addEventListener('change', onChange);
      onChange();

      //Код для кнопок масштаба
      zoom_plus.onclick = function() {
        var zoom = view.getZoom();
        view.setZoom(zoom + 1);
      };

      zoom_minus.onclick = function() {
        var zoom = view.getZoom();
        view.setZoom(zoom - 1);
      };

      //Код для кнопки поиска
      find_place.onclick = function() {
        var place = search.value;
        for (let i = 0; i < places.length; i++) {
          if(places[i] === place) var coordinate = savedCenter[i];
        }
        flyTo(coordinate, function() {});
      };

      //Код для кнопок включения-выключения слоя
      mapLayers.addEventListener('change', function() {
        mapLayerOn = mapLayers.checked;
        onChange();
      });

      RBLayers.addEventListener('change',function() {
        layers[layers.length - 1].setVisible(RBLayers.checked);
      });

      CitiesLayers.addEventListener('change',function() {
        layers[layers.length - 2].setVisible(CitiesLayers.checked);
      })

        flyTo(savedCenter[0], function() {}); //Для того, чтобы карта появлялась в центре Уфы, а не где-то в океане
		</script>
	</body>
</html>
